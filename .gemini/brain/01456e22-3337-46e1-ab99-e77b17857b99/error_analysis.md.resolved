# An√°lisis del Error en FondoRenta Extractor

## üìã Resumen del Error

Al intentar analizar un extracto bancario de FondoRenta, la aplicaci√≥n muestra **"Error en la petici√≥n: 500"** en el frontend y genera un error interno en el backend.

---

## üîç Causa Ra√≠z del Error

### Error Principal
```python
NameError: name 'snippet' is not defined
```

### Ubicaci√≥n del Error
- **Archivo**: [fondorenta.py](file:///F:/1.%20Cloud/4.%20AI/1.%20Antigravity/ConciliacionWeb/Backend/src/infrastructure/extractors/fondorenta.py#L142)
- **L√≠nea**: 142 y 150
- **Funci√≥n afectada**: [extraer_resumen_fondorenta()](file:///F:/1.%20Cloud/4.%20AI/1.%20Antigravity/ConciliacionWeb/Backend/src/infrastructure/extractors/fondorenta.py#102-153)

### Stack Trace Completo

```
File "procesador_archivos_service.py", line 303, in analizar_extracto
    datos = fondorenta.extraer_resumen_fondorenta(file_obj)

File "fondorenta.py", line 150, in extraer_resumen_fondorenta
    raise Exception(f"Error al leer resumen del PDF Fondo Renta: {e}")

File "fondorenta.py", line 142, in extraer_resumen_fondorenta
    raise ValueError(f"No se pudieron extraer datos. Verifique logs. Preview: {snippet[:200]}")
    
NameError: name 'snippet' is not defined
```

---

## üì∏ Evidencia Visual

![Error en Frontend](file:///C:/Users/Slb/.gemini/antigravity/brain/01456e22-3337-46e1-ab99-e77b17857b99/uploaded_image_0_1768567922696.png)

![Error en Backend - Logs](file:///C:/Users/Slb/.gemini/antigravity/brain/01456e22-3337-46e1-ab99-e77b17857b99/uploaded_image_1_1768567922696.png)

![Error en Backend - Traceback](file:///C:/Users/Slb/.gemini/antigravity/brain/01456e22-3337-46e1-ab99-e77b17857b99/uploaded_image_2_1768567922696.png)

---

## üî¨ An√°lisis T√©cnico Detallado

### C√≥digo Problem√°tico

En la **l√≠nea 142** de [fondorenta.py](file:///F:/1.%20Cloud/4.%20AI/1.%20Antigravity/ConciliacionWeb/Backend/src/infrastructure/extractors/fondorenta.py#L138-L142):

```python
# Si fall√≥, loguear POR QU√â
search_area = full_text[full_text.find('SALDO'):full_text.find('SALDO')+500] if 'SALDO' in full_text else 'No SALDO found'
logger.error(f"DEBUG FondoRenta FAILED. Search Area for SALDO: {search_area}")

# Lanzar error con snippet
raise ValueError(f"No se pudieron extraer datos. Verifique logs. Preview: {snippet[:200]}")
```

### Problema Identificado

La variable `snippet` **nunca fue definida** en el c√≥digo. El desarrollador anterior probablemente quiso usar `search_area` o `full_text` en lugar de `snippet`, pero dej√≥ esta referencia sin inicializar.

### Impacto

Cuando la funci√≥n [_extraer_resumen_desde_texto_full()](file:///F:/1.%20Cloud/4.%20AI/1.%20Antigravity/ConciliacionWeb/Backend/src/infrastructure/extractors/fondorenta.py#154-312) retorna `None` (l√≠nea 136), el c√≥digo intenta lanzar un error informativo para debugging, pero **falla antes de poder mostrar el mensaje** porque `snippet` no existe. Esto:

1. Oculta el error real de extracci√≥n del PDF
2. Genera un error secundario (`NameError`) que confunde el diagn√≥stico
3. Retorna un error gen√©rico 500 al frontend sin informaci√≥n √∫til
4. Dificulta el debugging de problemas leg√≠timos en la extracci√≥n del PDF

### Contexto del Flujo de Ejecuci√≥n

1. Usuario sube PDF de FondoRenta ‚Üí `analizar_extracto` endpoint
2. Se llama a [extraer_resumen_fondorenta(file_obj)](file:///F:/1.%20Cloud/4.%20AI/1.%20Antigravity/ConciliacionWeb/Backend/src/infrastructure/extractors/fondorenta.py#102-153) (l√≠nea 102)
3. Se extrae el texto completo del PDF (l√≠neas 115-120)
4. Se registra el texto en los logs (l√≠neas 124, 128-131)
5. Se llama a [_extraer_resumen_desde_texto_full(full_text)](file:///F:/1.%20Cloud/4.%20AI/1.%20Antigravity/ConciliacionWeb/Backend/src/infrastructure/extractors/fondorenta.py#154-312) (l√≠nea 133)
6. **Si la extracci√≥n falla** y retorna `None` (l√≠nea 136):
   - Se calcula `search_area` para debugging (l√≠nea 138)
   - Se registra el error en logs (l√≠nea 139)
   - **FALLA AQU√ç**: Se intenta usar `snippet` que no existe (l√≠nea 142) ‚ùå

---

## üéØ Soluci√≥n Propuesta

### Opci√≥n 1: Usar `search_area` (Recomendada)

Reemplazar `snippet` con `search_area`, que ya contiene un fragmento relevante del texto:

```python
raise ValueError(f"No se pudieron extraer datos. Verifique logs. Preview: {search_area[:200]}")
```

**Ventajas:**
- ‚úÖ Muestra el √°rea espec√≠fica donde se esperaba encontrar "SALDO"
- ‚úÖ Facilita el debugging al ver qu√© encontr√≥ (o no) el parser
- ‚úÖ Cambio m√≠nimo y directo

### Opci√≥n 2: Usar `full_text`

Usar el texto completo del PDF:

```python
raise ValueError(f"No se pudieron extraer datos. Verifique logs. Preview: {full_text[:200]}")
```

**Ventajas:**
- ‚úÖ Muestra el inicio del documento completo
- ‚ö†Ô∏è Puede ser menos relevante que `search_area`

### Opci√≥n 3: Mensaje sin preview

Simplificar el mensaje de error:

```python
raise ValueError("No se pudieron extraer datos del extracto FondoRenta. Verifique los logs para m√°s detalles.")
```

**Ventajas:**
- ‚úÖ M√°s simple y directo
- ‚ö†Ô∏è Menos informaci√≥n para debugging inmediato

---

## ‚ö†Ô∏è Consideraciones Adicionales

### ¬øPor qu√© fall√≥ la extracci√≥n original?

El `NameError` es un **error secundario** que oculta el problema real. Para entender por qu√© [_extraer_resumen_desde_texto_full()](file:///F:/1.%20Cloud/4.%20AI/1.%20Antigravity/ConciliacionWeb/Backend/src/infrastructure/extractors/fondorenta.py#154-312) retorn√≥ `None`, necesitamos:

1. Ver el contenido del archivo `debug_extract_dump.txt` (si se gener√≥)
2. Revisar los logs que muestran los primeros 3000 caracteres del PDF extra√≠do (l√≠nea 124)
3. Verificar si el formato del PDF cambi√≥ respecto a los patrones esperados

Los logs en la imagen 2 muestran que s√≠ se extrajo texto del PDF (se ven movimientos, fechas, valores), por lo que probablemente:
- El formato del cuadro de resumen cambi√≥
- Los regex de extracci√≥n no coinciden con el formato actual
- Hay alg√∫n problema con los encabezados o estructura de la tabla

### Debug Logs Disponibles

El c√≥digo ya tiene logging extensivo:
- L√≠nea 124: Loguea los primeros 3000 caracteres como ERROR
- L√≠nea 128-131: Intenta escribir el texto completo a `logs/debug_extract_dump.txt`
- L√≠nea 139: Loguea el √°rea de b√∫squeda de "SALDO"

Estos logs **deber√≠an estar visibles en la terminal** mostrada en las capturas de pantalla.

---

## üìù Pr√≥ximos Pasos

Despu√©s de corregir el `NameError`, ser√° necesario:

1. **Ver los logs completos** del texto extra√≠do del PDF
2. **Comparar** el formato real vs. los patrones regex esperados
3. **Ajustar** los regex si el formato del PDF ha cambiado
4. **Probar** nuevamente la carga del extracto
